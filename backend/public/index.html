<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFocus - Dashboard Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-6 max-w-6xl">
        
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-5 mb-6 fade-in border border-white/50">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-2xl shadow-lg">üéì</div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">EduFocus</h1>
                        <p class="text-sm text-gray-500">Tu asistente de aprendizaje inteligente</p>
                    </div>
                </div>
                <div id="userInfo" class="hidden flex items-center gap-4">
                    <div class="flex items-center gap-2 px-4 py-2 bg-yellow-100 rounded-full">
                        <span class="text-xl">üî•</span>
                        <span id="streakDisplay" class="font-bold text-orange-600">0</span>
                    </div>
                    <div class="flex items-center gap-2 px-4 py-2 bg-indigo-100 rounded-full">
                        <span class="text-xl">‚≠ê</span>
                        <span id="xpDisplay" class="font-bold text-indigo-600">0 XP</span>
                    </div>
                    <div class="flex items-center gap-2 px-4 py-2 bg-green-100 rounded-full">
                        <span class="text-xl">üìä</span>
                        <span id="levelDisplay" class="font-bold text-green-600">Nivel 1</span>
                    </div>
                    <span id="userNameDisplay" class="text-gray-600 font-medium"></span>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition-colors">üö™</button>
                </div>
            </div>
        </header>

        <!-- Auth Section -->
        <section id="authSection" class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 mb-6 fade-in border border-white/50">
            <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">üîê Inicia tu sesi√≥n</h2>
            <div class="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-5 rounded-xl">
                    <h3 class="font-medium mb-4 text-indigo-700 flex items-center gap-2">
                        <span>üìù</span> Registro r√°pido
                    </h3>
                    <input type="email" id="regEmail" placeholder="Email" class="w-full p-3 border border-indigo-200 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-400 outline-none">
                    <input type="password" id="regPassword" placeholder="Contrase√±a (m√≠nimo 6 caracteres)" class="w-full p-3 border border-indigo-200 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-400 outline-none">
                    <input type="date" id="regBirthDate" class="w-full p-3 border border-indigo-200 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-400 outline-none">
                    <select id="regRole" class="w-full p-3 border border-indigo-200 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-400 outline-none">
                        <option value="STUDENT">üéí Estudiante</option>
                        <option value="PARENT">üë®‚Äçüë©‚Äçüëß Padre/Madre</option>
                    </select>
                    <button onclick="register()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-medium py-3 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all shadow-lg">Crear cuenta</button>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-teal-50 p-5 rounded-xl">
                    <h3 class="font-medium mb-4 text-green-700 flex items-center gap-2">
                        <span>üîë</span> Iniciar sesi√≥n
                    </h3>
                    <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border border-green-200 rounded-lg mb-3 focus:ring-2 focus:ring-green-400 outline-none">
                    <input type="password" id="loginPassword" placeholder="Contrase√±a" class="w-full p-3 border border-green-200 rounded-lg mb-4 focus:ring-2 focus:ring-green-400 outline-none">
                    <button onclick="login()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white font-medium py-3 rounded-lg hover:from-green-600 hover:to-teal-700 transition-all shadow-lg">Entrar</button>
                </div>
            </div>
            <div id="authResult" class="mt-4 p-4 rounded-lg text-center hidden"></div>
        </section>

        <!-- Dashboard (shown after auth) -->
        <div id="dashboard" class="hidden">
            
            <!-- Stats Cards -->
            <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-4 fade-in border border-white/50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Nivel</p>
                            <p id="level" class="text-3xl font-bold text-indigo-600">1</p>
                        </div>
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-2xl">üèÜ</div>
                    </div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-4 fade-in border border-white/50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">XP Total</p>
                            <p id="xp" class="text-3xl font-bold text-yellow-500">0</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-2xl">‚≠ê</div>
                    </div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-4 fade-in border border-white/50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Racha</p>
                            <p id="streak" class="text-3xl font-bold text-orange-500">0</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center text-2xl">üî•</div>
                    </div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg p-4 fade-in border border-white/50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Tareas</p>
                            <p id="tasksCount" class="text-3xl font-bold text-green-500">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-2xl">üìã</div>
                    </div>
                </div>
            </section>

            <!-- Main Grid -->
            <div class="grid lg:grid-cols-2 gap-6">
                
                <!-- Tutor IA -->
                <section class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-5 fade-in border border-white/50">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-700">
                        <span class="text-2xl">ü§ñ</span> Tutor Inteligente
                    </h2>
                    <div id="tutorChat" class="h-72 overflow-y-auto border-2 border-indigo-100 rounded-xl p-4 mb-4 bg-gradient-to-br from-indigo-50/50 to-purple-50/50 space-y-3">
                        <div class="text-center text-gray-400 py-8">
                            <div class="text-4xl mb-2">üí°</div>
                            <p>Preg√∫ntame sobre cualquier tema:</p>
                            <p class="text-sm">Matem√°ticas, Historia, Ciencias...</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="tutorInput" placeholder="Escribe tu pregunta aqu√≠..." class="flex-1 p-3 border-2 border-indigo-200 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none" onkeypress="if(event.key==='Enter')sendTutorMessage()">
                        <button onclick="sendTutorMessage()" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-3 rounded-xl hover:from-indigo-600 hover:to-purple-700 transition-all font-medium shadow-lg">Enviar</button>
                    </div>
                </section>

                <!-- Tasks Manager -->
                <section class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-5 fade-in border border-white/50">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-700">
                        <span class="text-2xl">üìã</span> Mis Tareas
                        <span id="tasksBadge" class="ml-auto bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-medium">0</span>
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="taskTitle" placeholder="Nueva tarea..." class="flex-1 p-3 border-2 border-green-200 rounded-xl focus:ring-2 focus:ring-green-400 outline-none">
                        <select id="taskSubject" class="p-3 border-2 border-green-200 rounded-xl focus:ring-2 focus:ring-green-400 outline-none bg-white">
                            <option value="Matem√°tica">üìê</option>
                            <option value="Lengua Espa√±ola">üìù</option>
                            <option value="Historia">üìú</option>
                            <option value="Geografia">üó∫Ô∏è</option>
                            <option value="Ciencias">üî¨</option>
                            <option value="F√≠sica">‚ö°</option>
                            <option value="Qu√≠mica">üß™</option>
                        </select>
                        <button onclick="createTask()" class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-5 py-3 rounded-xl hover:from-green-600 hover:to-teal-700 transition-all font-medium shadow-lg">+</button>
                    </div>
                    <div id="tasksList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                        <!-- Tasks will be loaded here -->
                    </div>
                </section>

                <!-- Focus Mode -->
                <section class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-5 fade-in border border-white/50">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-700">
                        <span class="text-2xl">üçÖ</span> Focus Mode
                    </h2>
                    <div class="text-center py-4">
                        <div id="pomodoroDisplay" class="text-6xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-6 font-mono">25:00</div>
                        <div class="flex justify-center gap-3 mb-4">
                            <button onclick="startFocus()" class="flex items-center gap-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all font-medium shadow-lg">
                                <span>‚ñ∂Ô∏è</span> Iniciar
                            </button>
                            <button onclick="pauseFocus()" class="flex items-center gap-2 bg-gradient-to-r from-yellow-500 to-orange-600 text-white px-6 py-3 rounded-xl hover:from-yellow-600 hover:to-orange-700 transition-all font-medium shadow-lg">
                                <span>‚è∏Ô∏è</span> Pausar
                            </button>
                            <button onclick="stopFocus()" class="flex items-center gap-2 bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-3 rounded-xl hover:from-red-600 hover:to-pink-700 transition-all font-medium shadow-lg">
                                <span>‚èπÔ∏è</span> Detener
                            </button>
                        </div>
                        <div class="flex justify-center gap-4 text-sm text-gray-500">
                            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Focus (25 min)</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> Descanso (5 min)</span>
                        </div>
                    </div>
                </section>

                <!-- API Status -->
                <section class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-5 fade-in border border-white/50">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-700">
                        <span class="text-2xl">üîå</span> Estado del Sistema
                    </h2>
                    <div id="apiStatus" class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl">
                            <span class="flex items-center gap-2 text-gray-600">
                                <span class="text-lg">üåê</span> API EduFocus
                            </span>
                            <span id="apiHealth" class="text-green-600 font-medium flex items-center gap-1">
                                <span class="w-2 h-2 bg-green-500 rounded-full pulse"></span> Verificando...
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-teal-50 rounded-xl">
                            <span class="flex items-center gap-2 text-gray-600">
                                <span class="text-lg">üóÑÔ∏è</span> Base de Datos
                            </span>
                            <span id="apiDb" class="text-green-600 font-medium flex items-center gap-1">
                                <span class="w-2 h-2 bg-green-500 rounded-full pulse"></span> Verificando...
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl">
                            <span class="flex items-center gap-2 text-gray-600">
                                <span class="text-lg">üéì</span> Tutor IA
                            </span>
                            <span id="tutorStatus" class="text-yellow-600 font-medium flex items-center gap-1">
                                <span class="w-2 h-2 bg-yellow-500 rounded-full pulse"></span> Sin configurar
                            </span>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-gray-50 rounded-xl text-center">
                        <p class="text-xs text-gray-500">API: <span id="apiUrl" class="font-mono text-indigo-600"></span></p>
                    </div>
                </section>

            </div>

            <!-- Progress Section -->
            <section class="mt-6 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-5 fade-in border border-white/50">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-700">
                    <span class="text-2xl">üìà</span> Tu Progreso
                </h2>
                <div id="progressSection" class="grid md:grid-cols-3 gap-4">
                    <div class="text-center text-gray-500 py-8 col-span-3">
                        <div class="text-4xl mb-2">üìä</div>
                        <p>Completa actividades para ver tu progreso</p>
                    </div>
                </div>
            </section>

        </div>

        <!-- Toast Notifications -->
        <div id="toast" class="fixed bottom-4 right-4 bg-white shadow-xl rounded-xl p-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
            <span id="toastIcon" class="text-2xl"></span>
            <span id="toastMessage" class="text-gray-700 font-medium"></span>
        </div>

    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let token = localStorage.getItem('edufocus_token');
        let focusInterval = null;
        let focusTime = 25 * 60;
        let focusRunning = false;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiUrl').textContent = window.location.origin;
            checkApiStatus();
            if (token) {
                loadUserProfile();
            }
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            toast.className = 'fixed bottom-4 right-4 bg-white shadow-xl rounded-xl p-4 transform transition-all duration-300 z-50 flex items-center gap-3 border-l-4';
            toast.classList.add(type === 'success' ? 'border-green-500' : 'border-red-500');
            icon.textContent = type === 'success' ? '‚úÖ' : '‚ùå';
            msg.textContent = message;
            
            toast.style.transform = 'translateY(0)';
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.transform = 'translate-y-20 opacity-0';
            }, 3000);
        }

        async function checkApiStatus() {
            try {
                const res = await fetch(`${API_URL}/health`);
                const data = await res.json();
                document.getElementById('apiHealth').innerHTML = data.status === 'ok' 
                    ? '<span class="w-2 h-2 bg-green-500 rounded-full pulse"></span> Conectado' 
                    : '<span class="w-2 h-2 bg-red-500 rounded-full pulse"></span> Error';
                document.getElementById('apiDb').innerHTML = data.database === 'connected' 
                    ? '<span class="w-2 h-2 bg-green-500 rounded-full pulse"></span> Conectada' 
                    : '<span class="w-2 h-2 bg-yellow-500 rounded-full pulse"></span> Desconectada';
            } catch (e) {
                document.getElementById('apiHealth').innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full pulse"></span> Error';
                document.getElementById('apiDb').innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full pulse"></span> Error';
            }
        }

        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const birthDate = document.getElementById('regBirthDate').value;
            const role = document.getElementById('regRole').value;

            if (!email || !password || !birthDate) {
                showToast('Por favor completa todos los campos', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, birthDate, role })
                });
                const data = await res.json();
                
                if (res.ok) {
                    token = data.token;
                    localStorage.setItem('edufocus_token', token);
                    showToast('¬°Cuenta creada exitosamente!');
                    loadUserProfile();
                } else {
                    showToast(data.error || 'Error al registrar', 'error');
                }
            } catch (e) {
                showToast('Error de conexi√≥n', 'error');
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showToast('Email y contrase√±a requeridos', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                
                if (res.ok) {
                    token = data.token;
                    localStorage.setItem('edufocus_token', token);
                    showToast('¬°Bienvenido de nuevo!');
                    loadUserProfile();
                } else {
                    showToast(data.error || 'Credenciales inv√°lidas', 'error');
                }
            } catch (e) {
                showToast('Error de conexi√≥n', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('edufocus_token');
            token = null;
            location.reload();
        }

        async function loadUserProfile() {
            if (!token) return;

            try {
                const res = await fetch(`${API_URL}/users/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('userInfo').classList.remove('hidden');
                    document.getElementById('userInfo').classList.add('flex');
                    
                    const displayName = data.profile?.displayName || data.user?.email.split('@')[0];
                    document.getElementById('userNameDisplay').textContent = displayName;
                    document.getElementById('userNameDisplay').classList.add('text-gray-700', 'font-medium');
                    
                    updateStats(data.profile);
                    loadTasks();
                } else {
                    localStorage.removeItem('edufocus_token');
                    token = null;
                }
            } catch (e) {
                console.error('Error loading profile:', e);
            }
        }

        function updateStats(profile) {
            if (!profile) return;
            document.getElementById('level').textContent = profile.level || 1;
            document.getElementById('xp').textContent = profile.totalXP || 0;
            document.getElementById('streak').textContent = profile.currentStreak || 0;
            
            document.getElementById('levelDisplay').textContent = `Nivel ${profile.level || 1}`;
            document.getElementById('xpDisplay').textContent = `${profile.totalXP || 0} XP`;
            document.getElementById('streakDisplay').textContent = profile.currentStreak || 0;
        }

        async function loadTasks() {
            try {
                const res = await fetch(`${API_URL}/tasks`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    const tasks = data.tasks || [];
                    document.getElementById('tasksCount').textContent = tasks.length;
                    document.getElementById('tasksBadge').textContent = tasks.length;
                    
                    const list = document.getElementById('tasksList');
                    if (tasks.length === 0) {
                        list.innerHTML = `
                            <div class="text-center text-gray-400 py-6">
                                <div class="text-3xl mb-2">üìù</div>
                                <p class="text-sm">No tienes tareas pendientes</p>
                                <p class="text-xs">¬°Agrega una tarea para comenzar!</p>
                            </div>
                        `;
                    } else {
                        list.innerHTML = tasks.map(t => `
                            <div class="flex items-center gap-3 p-3 bg-gradient-to-r from-white to-gray-50 rounded-xl border border-gray-100 slide-in hover:shadow-md transition-shadow">
                                <input type="checkbox" ${t.isCompleted ? 'checked' : ''} 
                                    onchange="toggleTask('${t.id}', ${!t.isCompleted})"
                                    class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-gray-700 truncate ${t.isCompleted ? 'line-through text-gray-400' : ''}">${t.title}</p>
                                    <p class="text-xs text-gray-400">${t.subject} ‚Ä¢ ${t.estimatedMinutes} min</p>
                                </div>
                                <span class="text-sm px-2 py-1 rounded-full ${getDifficultyColor(t.difficulty)}">${getDifficultyText(t.difficulty)}</span>
                            </div>
                        `).join('');
                    }
                }
            } catch (e) {
                console.error('Error loading tasks:', e);
            }
        }

        function getDifficultyColor(difficulty) {
            if (difficulty <= 2) return 'bg-green-100 text-green-700';
            if (difficulty <= 3) return 'bg-yellow-100 text-yellow-700';
            return 'bg-red-100 text-red-700';
        }

        function getDifficultyText(difficulty) {
            if (difficulty <= 2) return 'F√°cil';
            if (difficulty <= 3) return 'Medio';
            return 'Dif√≠cil';
        }

        async function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const subject = document.getElementById('taskSubject').value;

            if (!title) {
                showToast('Escribe el t√≠tulo de la tarea', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        subject,
                        description: 'Tarea creada desde dashboard',
                        estimatedMinutes: 30,
                        difficulty: 3
                    })
                });

                if (res.ok) {
                    document.getElementById('taskTitle').value = '';
                    showToast('¬°Tarea agregada!');
                    loadTasks();
                } else {
                    showToast('Error al crear tarea', 'error');
                }
            } catch (e) {
                showToast('Error de conexi√≥n', 'error');
            }
        }

        async function toggleTask(id, completed) {
            try {
                await fetch(`${API_URL}/tasks/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isCompleted: completed })
                });
                loadTasks();
                if (completed) showToast('¬°Tarea completada! üéâ');
            } catch (e) {
                console.error('Error toggling task:', e);
            }
        }

        async function sendTutorMessage() {
            const input = document.getElementById('tutorInput');
            const message = input.value.trim();
            if (!message) return;

            const chat = document.getElementById('tutorChat');
            
            chat.innerHTML += `
                <div class="flex justify-end slide-in">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-2xl rounded-tr-sm max-w-xs">
                        ${message}
                    </div>
                </div>
            `;
            input.value = '';
            chat.scrollTop = chat.scrollHeight;
            document.getElementById('tutorStatus').innerHTML = '<span class="w-2 h-2 bg-purple-500 rounded-full pulse"></span> Respondiendo...';

            try {
                const res = await fetch(`${API_URL}/tutor/conversations`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: 'General',
                        topic: 'Ayuda',
                        initialMessage: message
                    })
                });
                const data = await res.json();

                if (res.ok) {
                    chat.innerHTML += `
                        <div class="flex justify-start slide-in">
                            <div class="bg-white border-2 border-indigo-100 text-gray-700 px-4 py-2 rounded-2 rounded-tl-sm max-w-xs shadow-sm">
                                ${data.tutorResponse}
                            </div>
                        </div>
                        <div class="text-left text-xs text-indigo-400 mt-1 ml-2 mb-3">üí° ${data.nextQuestion}</div>
                    `;
                    document.getElementById('tutorStatus').innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full pulse"></span> Activo';
                } else {
                    chat.innerHTML += `
                        <div class="flex justify-start slide-in">
                            <div class="bg-red-50 text-red-600 px-4 py-2 rounded-2xl rounded-tl-sm max-w-xs">
                                ${data.error || 'No se pudo procesar tu pregunta'}
                            </div>
                        </div>
                    `;
                    document.getElementById('tutorStatus').innerHTML = '<span class="w-2 h-2 bg-yellow-500 rounded-full pulse"></span> Sin configurar';
                }
            } catch (e) {
                chat.innerHTML += `
                    <div class="flex justify-start slide-in">
                        <div class="bg-red-50 text-red-600 px-4 py-2 rounded-2xl rounded-tl-sm max-w-xs">
                            Error de conexi√≥n. Intenta de nuevo.
                        </div>
                    </div>
                `;
            }
            chat.scrollTop = chat.scrollHeight;
        }

        function startFocus() {
            if (focusRunning) return;
            focusRunning = true;
            
            if (focusInterval) clearInterval(focusInterval);
            focusInterval = setInterval(() => {
                focusTime--;
                const min = Math.floor(focusTime / 60);
                const sec = focusTime % 60;
                document.getElementById('pomodoroDisplay').textContent = 
                    `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                
                if (focusTime <= 0) {
                    clearInterval(focusInterval);
                    focusRunning = false;
                    showToast('¬°Tiempo completado! Descansa 5 minutos üçÖ');
                    focusTime = 25 * 60;
                    document.getElementById('pomodoroDisplay').textContent = '25:00';
                }
            }, 1000);
            showToast('¬°Focusstarted! üéØ');
        }

        function pauseFocus() {
            if (focusInterval) {
                clearInterval(focusInterval);
                focusInterval = null;
                focusRunning = false;
            }
            showToast('Focus pausado');
        }

        function stopFocus() {
            if (focusInterval) clearInterval(focusInterval);
            focusTime = 25 * 60;
            focusRunning = false;
            document.getElementById('pomodoroDisplay').textContent = '25:00';
            showToast('Focus reiniciado');
        }
    </script>
</body>
</html>
