generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  passwordHash    String
  role            UserRole @default(STUDENT)
  birthDate       DateTime
  parentalConsent Boolean  @default(false)
  parentId        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  profile           StudentProfile?
  children          StudentProfile[] @relation("ParentStudent")
  tasks             Task[]
  studySessions     StudySession[]
  contentUploads    ContentUpload[]
  tutorConversations TutorConversation[]
}

enum UserRole {
  STUDENT
  PARENT
  ADMIN
}

model StudentProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  ageGroup        AgeGroup
  displayName     String
  avatarUrl       String?
  preferences     Json     @default("{}")
  currentStreak   Int      @default(0)
  totalXP         Int      @default(0)
  level           Int      @default(1)
  lastActiveAt    DateTime?
  createdAt       DateTime @default(now())
  
  parent          User?    @relation("ParentStudent", fields: [parentId], references: [id])
  parentId        String?
  badges          Badge[]
  projects        Project[]
}

enum AgeGroup {
  CHILD
  TEENAGER
}

model Badge {
  id        String   @id @default(uuid())
  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])
  badgeType String
  earnedAt  DateTime @default(now())
  
  @@unique([studentId, badgeType])
}

model Project {
  id          String   @id @default(uuid())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id])
  title       String
  subject     String
  deadline    DateTime
  priority    Priority @default(MEDIUM)
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  tasks       Task[]
}

model Task {
  id              String   @id @default(uuid())
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  studentId       String
  student         User     @relation(fields: [studentId], references: [id])
  title           String
  description     String?
  estimatedMinutes Int
  dueDate         DateTime?
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  difficulty      Int      @default(3)
  subject         String
  createdAt       DateTime @default(now())
  
  subtasks        SubTask[]
}

model SubTask {
  id          String   @id @default(uuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id])
  title       String
  isCompleted Boolean  @default(false)
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model StudySession {
  id          String   @id @default(uuid())
  studentId   String
  student     User     @relation(fields: [studentId], references: [id])
  startTime   DateTime
  endTime     DateTime?
  duration    Int?
  subject     String
  taskId      String?
  isActive    Boolean  @default(false)
}

model ContentUpload {
  id          String   @id @default(uuid())
  studentId   String
  student     User     @relation(fields: [studentId], references: [id])
  fileUrl     String
  fileType    String
  subject     String
  processed   Boolean  @default(false)
  summary     Json?
  createdAt   DateTime @default(now())
}

model TutorConversation {
  id          String   @id @default(uuid())
  studentId   String
  student     User     @relation(fields: [studentId], references: [id])
  subject     String
  topic       String
  messages    TutorMessage[]
  isResolved  Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model TutorMessage {
  id            String   @id @default(uuid())
  conversationId String
  conversation  TutorConversation @relation(fields: [conversationId], references: [id])
  role          String
  content       String
  context       Json?
  createdAt     DateTime @default(now())
}

model ProgressRecord {
  id          String   @id @default(uuid())
  studentId   String
  subject     String
  topic       String
  masteryLevel Float
  timeSpent   Int
  attempts    Int
  score       Float?
  recordedAt  DateTime @default(now())
  
  @@index([studentId, subject, recordedAt])
}
